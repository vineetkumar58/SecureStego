package src.main;

import src.main.controller.MainController;
import src.main.ui.AppUI;
import src.main.utils.Config;
import src.main.utils.ExceptionHandler;

import javax.swing.*;
import java.awt.*;
import java.io.File;

/**
 * Main Application Entry Point.
 * UPDATED: Implements System Log Logging, Decoy Logic, and Password-Seeding.
 * Fixes: "Cannot resolve setStatus" error.
 */
public class App {

    private final AppUI view;
    private final MainController controller;

    public App() {
        this.view = new AppUI();
        this.controller = new MainController(view); // Pass view to controller for logging

        // Initial Boot Logs
        view.log("BOOT SEQUENCE INITIATED...");
        view.log("LOADING CORE MODULES: AES-256, GZIP, PRNG-SCATTER");
        view.log("SYSTEM READY. WAITING FOR USER INPUT.");

        bindEvents();
        view.setVisible(true);
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(App::new);
    }

    private void bindEvents() {
        // ==================================================================
        // CRYPTOGRAPHY EVENTS
        // ==================================================================

        view.getEncryptBtn().addActionListener(e -> {
            if (isAuthMissing()) return;
            File src = getFileFromViewOrChooser("SELECT TARGET FOR ENCRYPTION", null);
            if (src == null) return;

            File dest = controller.showSaveDialog(view, "encrypted_artifact", Config.DESC_ENCRYPTED, Config.EXT_ENCRYPTED);
            if (dest == null) return;

            executeTask(() -> controller.encryptFile(src, dest, view.getPassword()));
        });

        view.getDecryptBtn().addActionListener(e -> {
            if (isAuthMissing()) return;
            File src = getFileFromViewOrChooser("SELECT ENCRYPTED ARTIFACT", new String[]{Config.EXT_ENCRYPTED});
            if (src == null) return;

            File dest = controller.showSaveDialog(view, "decrypted_file", "All Files", "");
            if (dest == null) return;

            executeTask(() -> controller.decryptFile(src, dest, view.getPassword()));
        });

        // ==================================================================
        // STEGANOGRAPHY EVENTS (Supports Decoy & Scatter)
        // ==================================================================

        // --- IMAGE OPERATIONS ---
        view.getHideImgBtn().addActionListener(e -> handleStegoEmbed("image", Config.EXT_IMAGES));
        view.getExtractImgBtn().addActionListener(e -> handleStegoExtract("image", Config.EXT_IMAGES));

        // --- AUDIO OPERATIONS ---
        view.getHideAudBtn().addActionListener(e -> handleStegoEmbed("audio", new String[]{Config.EXT_AUDIO_WAV}));
        view.getExtractAudBtn().addActionListener(e -> handleStegoExtract("audio", new String[]{Config.EXT_AUDIO_WAV}));

        // --- VIDEO OPERATIONS ---
        view.getHideVidBtn().addActionListener(e -> handleStegoEmbed("video", Config.EXT_VIDEOS));
        view.getExtractVidBtn().addActionListener(e -> handleStegoExtract("video", Config.EXT_VIDEOS));
    }

    /**
     * unified handler for Embedding Data (Hiding).
     * Now supports DECOY MODE flag.
     */
    private void handleStegoEmbed(String type, String[] extensions) {
        if (isAuthMissing()) return;
        if (view.getMessage().isEmpty()) {
            view.log("ERROR: PAYLOAD MISSING. ABORTING.");
            JOptionPane.showMessageDialog(view, "PAYLOAD DATA REQUIRED.", "INPUT ERROR", JOptionPane.WARNING_MESSAGE);
            return;
        }

        File src = getFileFromViewOrChooser("SELECT CARRIER " + type.toUpperCase(), extensions);
        if (src == null) return;

        String defaultExt = extensions[0];
        File dest = controller.showSaveDialog(view, "stego_" + type, type.toUpperCase(), defaultExt);
        if (dest == null) return;

        boolean useDecoy = view.isDecoyEnabled();
        String pass = view.getPassword();
        String msg = view.getMessage();

        if (useDecoy) {
            view.log("WARNING: DECOY PROTOCOL ACTIVE. DUAL-LAYER INJECTION.");
        }

        executeTask(() -> {
            switch (type) {
                case "image" -> controller.embedInImage(src, dest, msg, pass, useDecoy);
                case "audio" -> controller.embedInAudio(src, dest, msg, pass);
                case "video" -> controller.embedInVideo(src, dest, msg, pass);
            }
        });
    }

    private void handleStegoExtract(String type, String[] extensions) {
        if (isAuthMissing()) return;

        File src = getFileFromViewOrChooser("SELECT STEGO " + type.toUpperCase(), extensions);
        if (src == null) return;

        executeTask(() -> {
            String result = null;
            String pass = view.getPassword();

            switch (type) {
                case "image" -> result = controller.extractFromImage(src, pass);
                case "audio" -> result = controller.extractFromAudio(src, pass);
                case "video" -> result = controller.extractFromVideo(src, pass);
            }

            if (result != null) {
                String finalResult = result;
                SwingUtilities.invokeLater(() -> showResultDialog(finalResult));
            }
        });
    }

    // ==================================================================
    // UTILITIES
    // ==================================================================

    private File getFileFromViewOrChooser(String title, String[] extensions) {
        File dropped = view.getDroppedFile();
        if (dropped != null) {
            int c = JOptionPane.showConfirmDialog(view,
                    "USE DETECTED FILE: " + dropped.getName() + "?",
                    "FILE UPLOAD", JOptionPane.YES_NO_OPTION);

            view.clearDroppedFile();
            if (c == JOptionPane.YES_OPTION) return dropped;
        }
        return controller.showOpenDialog(view, title, extensions);
    }

    /**
     * Executes tasks on background thread with Terminal Logging.
     */
    private void executeTask(Runnable task) {
        view.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));

        new SwingWorker<Void, Void>() {
            @Override
            protected Void doInBackground() {
                try {
                    task.run();
                } catch (Exception e) {
                    view.log("CRITICAL ERROR: " + e.getMessage());
                    ExceptionHandler.handle(e, "OPERATION FAILED");
                }
                return null;
            }

            @Override
            protected void done() {
                view.setCursor(Cursor.getDefaultCursor());
                view.log("OPERATION COMPLETE.");
            }
        }.execute();
    }

    private boolean isAuthMissing() {
        if (view.getPassword().isEmpty()) {
            view.log("ACCESS DENIED: AUTH KEY REQUIRED.");
            JOptionPane.showMessageDialog(view, "AUTH KEY REQUIRED.", "ACCESS DENIED", JOptionPane.ERROR_MESSAGE);
            return true;
        }
        return false;
    }

    private void showResultDialog(String msg) {
        view.log("PAYLOAD EXTRACTED SUCCESSFULLY.");
        JTextArea area = new JTextArea(msg);
        area.setEditable(false);
        area.setLineWrap(true);
        area.setWrapStyleWord(true);
        area.setFont(Config.FONT_MONO);
        area.setForeground(Config.NEON_CYAN);
        area.setBackground(Config.DARK_PURPLE);

        JScrollPane scroll = new JScrollPane(area);
        scroll.setPreferredSize(new Dimension(500, 300));

        JOptionPane.showMessageDialog(view, scroll, "DECRYPTED PAYLOAD", JOptionPane.INFORMATION_MESSAGE);
    }
}